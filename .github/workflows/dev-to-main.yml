name: Dev to Main Pipeline

on:
  push:
    branches: [dev]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  TF_VERSION: '1.5.0'

jobs:
  terraform-validation:
    name: Terraform Validation and Plan
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref || github.ref }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Create output directory
      run: mkdir -p terraform/output

    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -recursive
      working-directory: ./terraform

    - name: Terraform Init
      id: init
      run: terraform init
      working-directory: ./terraform

    - name: Terraform Validate
      id: validate
      run: terraform validate
      working-directory: ./terraform

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -no-color -input=false \
          -var="environment=main" \
          -var="branch_name=${{ github.head_ref || github.ref_name }}" \
          -var="last_updated_by=${{ github.actor }}" \
          -var-file=../environments/main/terraform.tfvars \
          -out=tfplan
      working-directory: ./terraform
      continue-on-error: false

    - name: Create or Update PR to Main
      if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: 'dev',
              base: 'main'
            });
            
            if (existingPRs.length === 0) {
              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Auto PR: dev to main',
                head: 'dev',
                base: 'main',
                body: 'This PR was automatically created by GitHub Actions from dev to main'
              });
              console.log('Created PR:', pr.data.number);
            }
          } catch (error) {
            console.log('PR creation failed:', error.message);
          }

    - name: Update PR with Plan Output
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      env:
        PLAN: "${{ steps.plan.outputs.stdout }}"
      with:
        script: |
          const output = `## Terraform CI/CD Validation Results - Main Environment ‚úÖ

          ### Validation Checks:
          - **Format Check**: \`${{ steps.fmt.outcome }}\`
          - **Initialization**: \`${{ steps.init.outcome }}\`
          - **Syntax Validation**: \`${{ steps.validate.outcome }}\`
          - **Execution Plan**: \`${{ steps.plan.outcome }}\`

          ### Terraform Plan Output:
          <details>
          <summary>üìã Click to view detailed plan</summary>
          
          \`\`\`terraform
          ${process.env.PLAN}
          \`\`\`
          
          </details>

          ---
          *Pushed by: @${{ github.actor }}*`;
          
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.data.find(comment => 
            comment.body.includes('Terraform CI/CD Validation Results')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: output
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: output
            });
          }

  auto-merge-main:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == false
    name: Auto Merge to Main
    runs-on: ubuntu-latest
    needs: [terraform-validation]
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Check if PR is approved and mergeable
      id: check-merge-main
      uses: actions/github-script@v6
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const approvals = reviews.filter(review => 
            review.state === 'APPROVED'
          );
          
          console.log(`PR Status:`, {
            mergeable: pr.mergeable,
            approvalsCount: approvals.length,
            prState: pr.state,
            requiredApprovals: 1
          });
          
          // STRICT CHECK: Must have at least 1 approval
          if (pr.mergeable && approvals.length >= 1 && pr.state === 'open') {
            console.log(`‚úÖ PR approved and mergeable with ${approvals.length} approval(s)`);
            return true;
          } else {
            console.log(`‚ùå PR not ready for merge. Need 1 approval, got ${approvals.length}`);
            return false;
          }

    - name: Auto Merge to Main
      if: steps.check-merge-main.outputs.result == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            const result = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'merge'
            });
            console.log('‚úÖ PR merged successfully to main');
            
            // Add a comment about the merge
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ PR automatically merged by CI/CD pipeline with approval`
            });
          } catch (error) {
            console.log('‚ùå Merge failed:', error.message);
            // Comment on PR about merge failure
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå Auto-merge failed: ${error.message}`
            });
          }

    - name: Skip Merge - Waiting for Approval
      if: steps.check-merge-main.outputs.result == 'false'
      run: |
        echo "‚è≥ PR is mergeable but waiting for required approval(s)"
        echo "Current PR needs at least 1 approval before auto-merge"

  terraform-apply:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Terraform Apply to Main
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Create output directory
      run: mkdir -p terraform/output

    - name: Terraform Init
      run: terraform init
      working-directory: ./terraform

    - name: Check for Changes
      id: changes
      run: |
        terraform plan -detailed-exitcode -input=false \
          -var="environment=main" \
          -var="branch_name=main" \
          -var="last_updated_by=github-action" \
          -var-file=../environments/main/terraform.tfvars \
          -no-color
      working-directory: ./terraform
      continue-on-error: true

    - name: Terraform Apply
      if: steps.changes.outcome == 'failure'
      run: |
        terraform apply -auto-approve -input=false \
          -var="environment=main" \
          -var="branch_name=main" \
          -var="last_updated_by=github-action" \
          -var-file=../environments/main/terraform.tfvars
      working-directory: ./terraform

    - name: No Changes Detected
      if: steps.changes.outcome == 'success'
      run: echo "‚úÖ No infrastructure changes detected. Skipping apply."
