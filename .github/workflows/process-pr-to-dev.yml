name: Process PR to Dev

on:
  pull_request:
    branches: [dev]
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:  # ‚Üê THIS IS THE KEY - allows manual trigger
    inputs:
      pr_number:
        description: 'PR Number to process'
        required: true
        type: string

env:
  TF_VERSION: '1.5.0'

jobs:
  terraform-validation:
    name: Terraform Validation and Plan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - name: Determine PR Number
      id: pr-number
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "pr_number=${{ github.event.inputs.pr_number }}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        fi
        echo "Using PR number: $(echo ${{ github.event.inputs.pr_number || github.event.pull_request.number }})"

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Create output directory
      run: mkdir -p terraform/output

    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -recursive
      working-directory: ./terraform

    - name: Terraform Init
      id: init
      run: terraform init
      working-directory: ./terraform

    - name: Terraform Validate
      id: validate
      run: terraform validate
      working-directory: ./terraform

    - name: Terraform Plan
      id: plan
      run: |
        terraform plan -no-color -input=false \
          -var="environment=dev" \
          -var="branch_name=${{ github.head_ref }}" \
          -var="last_updated_by=${{ github.actor }}" \
          -var-file=../environments/dev/terraform.tfvars
      working-directory: ./terraform

    - name: Update PR with Plan Output
      uses: actions/github-script@v6
      env:
        PLAN: "${{ steps.plan.outputs.stdout }}"
      with:
        script: |
          const prNumber = '${{ steps.pr-number.outputs.pr_number }}' || context.issue.number;
          console.log('Updating PR:', prNumber);
          
          const output = `## Terraform CI/CD Validation Results ‚úÖ

          ### Validation Checks:
          - **Format Check**: \`${{ steps.fmt.outcome }}\`
          - **Initialization**: \`${{ steps.init.outcome }}\`
          - **Syntax Validation**: \`${{ steps.validate.outcome }}\`
          - **Execution Plan**: \`${{ steps.plan.outcome }}\`

          ### Terraform Plan Output:
          <details>
          <summary>üìã Click to view detailed plan</summary>
          
          \`\`\`terraform
          ${process.env.PLAN}
          \`\`\`
          
          </details>

          ---
          *Pushed by: @${{ github.actor }}*`;
          
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const existingComment = comments.data.find(comment => 
            comment.body.includes('Terraform CI/CD Validation Results')
          );
          
          if (existingComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: output
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: output
            });
          }

  auto-merge:
    if: github.event_name == 'pull_request_review' && github.event.review.state == 'approved'
    name: Auto Merge to Dev
    runs-on: ubuntu-latest
    needs: [terraform-validation]
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.AUTO_PR_TOKEN }}

    - name: Verify PR is mergeable
      id: verify-merge
      uses: actions/github-script@v6
      with:
        script: |
          const { data: pr } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const { data: reviews } = await github.rest.pulls.listReviews({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
          });
          
          const approvals = reviews.filter(review => 
            review.state === 'APPROVED'
          );
          
          console.log('PR Merge Check:', {
            mergeable: pr.mergeable,
            state: pr.state,
            merged: pr.merged,
            approvals: approvals.length
          });
          
          if (pr.mergeable && pr.state === 'open' && !pr.merged && approvals.length >= 1) {
            console.log('‚úÖ PR is ready for auto-merge');
            core.setOutput('ready', 'true');
          } else {
            console.log('‚ùå PR not ready for auto-merge');
            core.setOutput('ready', 'false');
          }

    - name: Auto Merge to Dev
      if: steps.verify-merge.outputs.ready == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            console.log('üöÄ Starting auto-merge to dev...');
            
            const result = await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              merge_method: 'merge'
            });
            
            console.log('‚úÖ PR merged successfully to dev:', result.data.merged);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚úÖ PR automatically merged to dev after approval! üöÄ'
            });
            
          } catch (error) {
            console.error('‚ùå Merge failed:', error.message);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå Auto-merge failed: ${error.message}`
            });
          }